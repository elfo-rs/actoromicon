<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Protocol Evolution - The Actoromicon</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="custom.css">
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="ch01-00-introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch01-01-comparison.html"><strong aria-hidden="true">1.1.</strong> Comparison</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Getting Started</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">2.1.</strong> Installation</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.2.</strong> Hello, World!</div></li></ol></li><li class="chapter-item expanded "><a href="ch03-00-actors.html"><strong aria-hidden="true">3.</strong> Actors</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch03-01-actor-lifecycle.html"><strong aria-hidden="true">3.1.</strong> Actor Lifecycle</a></li><li class="chapter-item expanded "><a href="ch03-02-communication.html"><strong aria-hidden="true">3.2.</strong> Communication</a></li><li class="chapter-item expanded "><a href="ch03-03-sources.html"><strong aria-hidden="true">3.3.</strong> Sources</a></li><li class="chapter-item expanded "><a href="ch03-04-structural-actors.html"><strong aria-hidden="true">3.4.</strong> Structural Actors</a></li></ol></li><li class="chapter-item expanded "><a href="ch04-00-groups.html"><strong aria-hidden="true">4.</strong> Actor Groups</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch04-01-routing.html"><strong aria-hidden="true">4.1.</strong> Routing</a></li><li class="chapter-item expanded "><a href="ch04-02-supervision.html"><strong aria-hidden="true">4.2.</strong> Supervision</a></li><li class="chapter-item expanded "><a href="ch04-03-configuration.html"><strong aria-hidden="true">4.3.</strong> Configuration</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.4.</strong> Multiple Runtimes</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Utility</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch05-01-logging.html"><strong aria-hidden="true">5.1.</strong> Logging</a></li><li class="chapter-item expanded "><a href="ch05-02-telemetry.html"><strong aria-hidden="true">5.2.</strong> Telemetry</a></li><li class="chapter-item expanded "><a href="ch05-03-dumping.html"><strong aria-hidden="true">5.3.</strong> Dumping</a></li><li class="chapter-item expanded "><a href="ch05-04-tracing.html"><strong aria-hidden="true">5.4.</strong> Tracing</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Distribution</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">6.1.</strong> Transport</div></li><li class="chapter-item expanded "><a href="ch06-02-protocol-evolution.html" class="active"><strong aria-hidden="true">6.2.</strong> Protocol Evolution</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> Testing</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">7.1.</strong> Unit Testing</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.2.</strong> The Replayer</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.3.</strong> Approval Testing</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.4.</strong> Stress Testing</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> Conventions</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch08-01-project-structure.html"><strong aria-hidden="true">8.1.</strong> Project Structure</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.</strong> Deployment</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.</strong> Patterns</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch10-01-id-generation.html"><strong aria-hidden="true">10.1.</strong> Pattern: ID Generation</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.2.</strong> Pattern: Network servers</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.3.</strong> Pattern: Pub/Sub</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.4.</strong> Pattern: A Workqueue</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.5.</strong> Pattern: CQS</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.6.</strong> Pattern: Event Sourcing</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.7.</strong> Pattern: Transactions</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.8.</strong> Pattern: Frontend as an Actor</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.9.</strong> Pattern: Gateways</div></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Actoromicon</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="protocol-evolution"><a class="header" href="#protocol-evolution">Protocol Evolution</a></h1>
<p>It's hard to update all nodes in distributed systems simultaneously. Firstly, it requires synchronization of releases and teams. Secondly, it means all nodes become unavailable until the update is finished, which can be highly unpleasant for users.</p>
<p>An alternative approach is updating nodes one by one without any kind of locks between them. However, they can become incompatible with each other because the communication protocol has evolved. That's where a protocol evolution appears. If a message is sent to another node, we should be more careful when changing it.</p>
<p>Communication is based on the <code>msgpack</code> format. It's close to <code>JSON</code>, but binary encoded and more feature-rich: it supports arbitrary map keys, special values of floats (<code>NaN</code>, <code>Â±inf</code>), and binary data. However, the ability to evolve is the same, so the rules of evolution are also similar.</p>
<p>It's worth noting that the compatibility of nodes can be checked automatically on a per-message basis (because it's known where a message is used on the sender and receiver part). However, it's unimplemented right now.</p>
<h2 id="the-common-principle"><a class="header" href="#the-common-principle">The common principle</a></h2>
<p>Messages are defined in so-called protocol crates. They shouldn't contain any logic, only message definitions and convenient constructors, getters, and setters for them. To understand the common principle of evolution, it needs to distinguish nodes that send a message from those that receive it. Senders and receivers are compiled with different versions of the same protocol crate.</p>
<p>The common principle states: <strong>senders should send a more specific version of a message than receivers accept</strong>.</p>
<p>In this way, if a message in the protocol becomes more specific (e.g., it gets more fields), then senders must be updated first. And, vice versa, if a message becomes less specific (e.g., losing fields), receivers must be updated first. Some changes allow any orders of updating; see the next section for details.</p>
<p>In the case of downgrading nodes, the update order is the opposite.</p>
<p>Let's consider some example of evolution:
<img src="assets/protocol-evolution-example.drawio.svg" alt="" /></p>
<p>It's a simple example of evolution with only adding required fields, but it helps to understand the common principle. Providing more fields from a sender than a receiver expects is always acceptable because a receiver can skip these fields during deserialization. If a receiver is updated first, it will expect more fields, and deserialization will fail.</p>
<p>This principle can be propagated to multiple updates as well:
<img src="assets/protocol-evolution-steps.drawio.svg" alt="" /></p>
<p>At step 2, the message becomes more specific, so senders are updated first. At step 4, the message becomes less specific, so receivers are updated first.</p>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<table class="protocol-evolution">
<thead><tr>
<td>Action</td><td>Current version</td><td>Next version</td><td>Update ordering</td>
</tr></thead>
<tbody>
<tr><td>
<p>Adding a new required field</p>
</td><td>
<pre><code class="language-rust ignore">#[message]
struct Sample {
    a: u32,
}
</code></pre>
</td><td>
<pre><code class="language-rust ignore">#[message]
struct Sample {
    a: u32,
    b: u32,
}
</code></pre>
</td><td>
<p>Sender, Receiver</p>
</td></tr>
<tr><td>
<p>Adding a new optional field</p>
</td><td>
<pre><code class="language-rust ignore">#[message]
struct Sample {
    a: u32,
}
</code></pre>
</td><td>
<pre><code class="language-rust ignore">#[message]
struct Sample {
    a: u32,
    #[serde(default)]
    b: u32,
    c: Option&lt;u32&gt;,
}
</code></pre>
</td><td>
<p>Any</p>
</td></tr>
<tr><td>
<p>Renaming a field</p>
</td><td>
<pre><code class="language-rust ignore">#[message]
struct Sample {
    a: u32,
}
</code></pre>
</td><td>
<pre><code class="language-rust ignore">#[message]
struct Sample {
    #[serde(alias = &quot;a&quot;)]
    b: u32,
}
</code></pre>
</td><td>
<p>Receiver, Sender</p>
</td></tr>
<tr><td>
<p>Removing a required field</p>
</td><td>
<pre><code class="language-rust ignore">#[message]
struct Sample {
    a: u32,
    b: u32,
}
</code></pre>
</td><td>
<pre><code class="language-rust ignore">#[message]
struct Sample {
    a: u32,
}
</code></pre>
</td><td>
<p>Receiver, Sender</p>
</td></tr>
<tr><td>
<p>Promotion of numbers<sup class="footnote-reference"><a href="#promotion">1</a></sup></p>
</td><td>
<pre><code class="language-rust ignore">#[message]
struct Sample {
    a: u32,
}
</code></pre>
</td><td>
<pre><code class="language-rust ignore">#[message]
struct Sample {
    a: u64,
    // Any numeric
    // a: i16
}
</code></pre>
</td><td>
<p>Any</p>
</td></tr>
<tr><td>
<p>(Un)wrapping into a newtype</p>
</td><td>
<pre><code class="language-rust ignore">#[message]
struct Sample {
    a: u32,
}
</code></pre>
</td><td>
<pre><code class="language-rust ignore">#[message]
struct Sample {
    a: U32,
}

#[message(part)]
struct U32(u32);
</code></pre>
</td><td>
<p>Any</p>
</td></tr>
<tr><td>
<p>Adding a new variant</p>
</td><td>
<pre><code class="language-rust ignore">#[message]
enum Sample {
    A(u32),
}
</code></pre>
</td><td>
<pre><code class="language-rust ignore">#[message]
enum Sample {
    A(u32),
    B(u32),
}
</code></pre>
</td><td>
<p>Receiver, Sender</p>
</td></tr>
<tr><td>
<p>Renaming a variant</p>
</td><td>
<pre><code class="language-rust ignore">#[message]
enum Sample {
    A(u32),
}
</code></pre>
</td><td>
<pre><code class="language-rust ignore">#[message]
enum Sample {
    #[serde(alias = &quot;A&quot;)]
    B(u32),
}
</code></pre>
</td><td>
<p>Receiver, Sender</p>
</td></tr>
<tr><td>
<p>Removing a variant</p>
</td><td>
<pre><code class="language-rust ignore">#[message]
enum Sample {
    A(u32),
    B(u32),
}
</code></pre>
</td><td>
<pre><code class="language-rust ignore">#[message]
enum Sample {
    A(u32),
}
</code></pre>
</td><td>
<p>Sender, Receiver</p>
</td></tr>
<tr><td>
<p>Replacing a field with an union (a untagged enumeration)</p>
</td><td>
<pre><code class="language-rust ignore">#[message]
struct Sample {
    a: u32,
}
</code></pre>
</td><td>
<pre><code class="language-rust ignore">#[message]
struct Sample {
    a: NumOrStr,
}

#[message(part)]
#[serde(untagged)]
enum NumOrStr {
    Num(u32),
    Str(String),
}
</code></pre>
</td><td>
<p>Any</p>
</td></tr>
<tr><td>
<p>Removing a variant</p>
</td><td>
<pre><code class="language-rust ignore">#[message]
enum Sample {
    A(u32),
    B(u32),
}
</code></pre>
</td><td>
<pre><code class="language-rust ignore">#[message]
enum Sample {
    A(u32),
}
</code></pre>
</td><td>
<p>Sender, Receiver</p>
</td></tr>
<tr><td>
<p>Enumerations with <code>serde(other)</code></p>
</td><td>
<pre><code class="language-rust ignore">#[message]
enum Sample {
    A,
    B,
}
</code></pre>
</td><td>
<pre><code class="language-rust ignore">#[message]
enum Sample {
    A,
    #[serde(other)]
    O,
}
</code></pre>
</td><td>
<p>Receiver, Sender</p>
</td></tr>
</tbody>
</table>
<div class="footnote-definition" id="promotion"><sup class="footnote-definition-label">1</sup>
<p>Promotion to/from <code>i128</code> and <code>u128</code> doesn't work due to <code>msgpack</code>'s implementation details.</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ch05-04-tracing.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="ch08-01-project-structure.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ch05-04-tracing.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="ch08-01-project-structure.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
